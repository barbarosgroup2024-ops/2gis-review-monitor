/**
 * Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ "Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Telegram Ğ±Ğ¾Ñ‚"
 * 
 * Ğ­Ñ‚Ğ¾Ñ‚ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ½ÑƒĞ¶Ğ½Ğ° Ğ»Ğ¸ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ, Ğ¸ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸
 * Ğ´Ğ»Ñ ĞµĞµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ² Supabase Dashboard
 */

const { createClient } = require('@supabase/supabase-js');
const fs = require('fs');
const path = require('path');
require('dotenv').config();

const supabaseUrl = process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_KEY;

if (!supabaseUrl || !supabaseKey) {
  console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: SUPABASE_URL Ğ¸Ğ»Ğ¸ SUPABASE_SERVICE_KEY Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ğ² .env');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

async function checkMigrationStatus() {
  console.log('ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸...\n');

  try {
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ»Ğ¸ Ğ¿Ğ¾Ğ»Ğµ telegram_activation_code
    const { data, error } = await supabase
      .from('companies')
      .select('telegram_activation_code')
      .limit(1);

    if (error) {
      if (error.message.includes('column') && error.message.includes('does not exist')) {
        console.log('âš ï¸  ĞŸĞ¾Ğ»Ğµ telegram_activation_code Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ - Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ\n');
        return false;
      }
      throw error;
    }

    console.log('âœ… ĞŸĞ¾Ğ»Ğµ telegram_activation_code ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚\n');
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ
    const { data: companies, error: statsError } = await supabase
      .from('companies')
      .select('id, company_name, telegram_activation_code, telegram_activated, telegram_user_id');

    if (statsError) throw statsError;

    console.log('ğŸ“Š Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:');
    console.log(`   Ğ’ÑĞµĞ³Ğ¾ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹: ${companies.length}`);
    console.log(`   Ğ¡ ĞºĞ¾Ğ´Ğ°Ğ¼Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸: ${companies.filter(c => c.telegram_activation_code).length}`);
    console.log(`   ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ…: ${companies.filter(c => c.telegram_activated).length}`);
    console.log('');

    if (companies.length > 0) {
      console.log('ğŸ“‹ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ ĞºĞ¾Ğ´Ğ¾Ğ² Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸:');
      companies.slice(0, 3).forEach(c => {
        console.log(`   ${c.company_name}: ${c.telegram_activation_code || 'Ğ½Ğµ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½'}`);
      });
      console.log('');
    }

    return true;
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ:', error.message);
    return false;
  }
}

async function main() {
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘   ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ: Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Telegram Ğ±Ğ¾Ñ‚ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹         â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('');

  const migrationExists = await checkMigrationStatus();

  if (migrationExists) {
    console.log('âœ… ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ ÑƒĞ¶Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°!');
    console.log('');
    console.log('ğŸ’¡ Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ:');
    console.log('   SELECT * FROM telegram_activation_status;');
    console.log('');
    console.log('ğŸ’¡ Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¼ Ğ¿Ğ¾Ñ€Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñ‹:');
    console.log('   SELECT * FROM get_companies_to_check();');
    console.log('');
    return;
  }

  console.log('ğŸ“ Ğ”Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸:');
  console.log('');
  console.log('1ï¸âƒ£  ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Supabase SQL Editor:');
  console.log(`   ${supabaseUrl.replace('//', '//app.')}/project/_/sql`);
  console.log('');
  console.log('2ï¸âƒ£  Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ°:');
  console.log('   database/migrations/unified_telegram_bot.sql');
  console.log('');
  console.log('3ï¸âƒ£  Ğ’ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ SQL Ğ² Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "Run"');
  console.log('');
  console.log('4ï¸âƒ£  ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ');
  console.log('');

  // Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ¸ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ SQL
  const migrationPath = path.join(__dirname, 'database', 'migrations', 'unified_telegram_bot.sql');
  
  if (fs.existsSync(migrationPath)) {
    const sql = fs.readFileSync(migrationPath, 'utf8');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('SQL Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ:');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('');
    console.log(sql);
    console.log('');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  } else {
    console.log('âš ï¸  Ğ¤Ğ°Ğ¹Ğ» Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½:', migrationPath);
  }

  console.log('');
  console.log('ğŸ“š Ğ§Ñ‚Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ ÑÑ‚Ğ° Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ:');
  console.log('');
  console.log('   âœ… ĞĞ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ companies:');
  console.log('      - two_gis_profile_url (ÑÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸)');
  console.log('      - telegram_activation_code (ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ´Ğ»Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸)');
  console.log('      - telegram_user_id (ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Telegram)');
  console.log('      - telegram_username (username Ğ² Telegram)');
  console.log('      - telegram_activated (ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸)');
  console.log('      - telegram_activated_at (Ğ´Ğ°Ñ‚Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸)');
  console.log('      - check_interval_minutes (Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ» Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²)');
  console.log('      - min_rating_filter (Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸)');
  console.log('      - max_rating_filter (Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸)');
  console.log('      - last_check_at (Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸)');
  console.log('      - telegram_notifications_enabled (Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹ Ğ»Ğ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ)');
  console.log('');
  console.log('   âœ… Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²');
  console.log('');
  console.log('   âœ… ĞŸÑ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ telegram_activation_status');
  console.log('      (Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸ Ğ²ÑĞµÑ… ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹)');
  console.log('');
  console.log('   âœ… Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ get_companies_to_check()');
  console.log('      (Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¼ Ğ¿Ğ¾Ñ€Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñ‹)');
  console.log('');
  console.log('   âœ… Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ generate_activation_code()');
  console.log('      (Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… ĞºĞ¾Ğ´Ğ¾Ğ² Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸)');
  console.log('');
  console.log('   âœ… ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ´Ğ¾Ğ² Ğ´Ğ»Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹');
  console.log('');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('');
}

main().catch(console.error);